<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Starting work with Lesan - Lesan</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="getting_start.html"><strong aria-hidden="true">2.</strong> Getting start</a></li><li class="chapter-item expanded affix "><li class="part-title">Philosophy</li><li class="chapter-item expanded "><a href="Receiving_Data.html"><strong aria-hidden="true">3.</strong> Receiving Data</a></li><li class="chapter-item expanded "><a href="Previous_methods_and_the_main_challenge.html"><strong aria-hidden="true">4.</strong> Previous methods and the main challenge</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Lesan's_Solution_For_How_To_Communicate_Between_The_Server_And_The_Client.html"><strong aria-hidden="true">4.1.</strong> Lesan's Solution For How To Communicate Between The Server And The Client</a></li><li class="chapter-item expanded "><a href="Why_NoSQL.html"><strong aria-hidden="true">4.2.</strong> Why noSQL?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Penetration_Into_Depths.html"><strong aria-hidden="true">4.2.1.</strong> Penetration Into Depths</a></li></ol></li><li class="chapter-item expanded "><a href="Microservice.html"><strong aria-hidden="true">4.3.</strong> Microservice</a></li><li class="chapter-item expanded "><a href="Lesan_solution.html"><strong aria-hidden="true">4.4.</strong> Lesan solution</a></li></ol></li><li class="chapter-item expanded "><a href="Starting_work_with_Lesan.html" class="active"><strong aria-hidden="true">5.</strong> Starting work with Lesan</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Microservice_Architecture_with_Lesan.html"><strong aria-hidden="true">5.1.</strong> Microservice Architecture with Lesan</a></li></ol></li><li class="chapter-item expanded "><a href="Structures.html"><strong aria-hidden="true">6.</strong> Structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Schemas.html"><strong aria-hidden="true">6.1.</strong> Schemas</a></li><li class="chapter-item expanded "><a href="Pure_Structure_In_Schema.html"><strong aria-hidden="true">6.2.</strong> Pure Structure In Schema</a></li><li class="chapter-item expanded "><a href="The_InRelation_Structure_In_Schema.html"><strong aria-hidden="true">6.3.</strong> The InRelation Structure In Schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_OutRelation_in_the_schema.html"><strong aria-hidden="true">6.4.</strong> The structure of OutRelation in the schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_embed_in_the_schema.html"><strong aria-hidden="true">6.5.</strong> The structure of embed in the schema</a></li><li class="chapter-item expanded "><a href="The_structure_of_Struct_in_the_schema.html"><strong aria-hidden="true">6.6.</strong> The structure of Struct in the schema</a></li><li class="chapter-item expanded "><a href="runServer_(web_server_structure).html"><strong aria-hidden="true">6.7.</strong> runServer (web server structure)</a></li><li class="chapter-item expanded "><a href="Request_processing.html"><strong aria-hidden="true">6.8.</strong> Request processing</a></li><li class="chapter-item expanded "><a href="Dynamic_structure.html"><strong aria-hidden="true">6.9.</strong> Dynamic structure</a></li><li class="chapter-item expanded "><a href="Static_structure.html"><strong aria-hidden="true">6.10.</strong> Static structure</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lesan</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="starting-work-with-lesan"><a class="header" href="#starting-work-with-lesan">Starting work with Lesan</a></h1>
<p>Let's create a simple web server with deno:</p>
<p>You can find a complete implementation of this example <a href="https://github.com/MiaadTeam/lesan/tree/main/examples/simpleMircoservice">here</a>.</p>
<p>First of all, create a mod.ts file and import the latest version of lesan and assign it to a constant variable called coreApp:</p>
<pre><code class="language-typescript">import { lesan } from &quot;https://deno.land/x/lesan@vx.xx/mod.ts&quot;;

const coreApp = lesan();
</code></pre>
<h6 id="please-select-the-final-version-of-lusan-from-here-and-replace-xxx-with-it"><a class="header" href="#please-select-the-final-version-of-lusan-from-here-and-replace-xxx-with-it">Please select the final version of Lusan from <a href="https://deno.land/x/lusan">here</a> and replace xxx with it.</a></h6>
<p>Before anything, let's connect a database to our app, so add a new MongoDb instance to your code.</p>
<p>First, import MongoClient from lesan:</p>
<pre><code class="language-typescript">import { lesan, MongoClient } from &quot;https://deno.land/x/lesan@vx.xx/mod.ts&quot;;
</code></pre>
<p>and create a database instance via new MongoClient:</p>
<pre><code class="language-typescript">const client = new MongoClient();

await client.connect(&quot;mongodb://localhost:27017/${your_database_name}&quot;);

const db = client.database(&quot;core&quot;);
</code></pre>
<p>We should set up the ODM with a new database instance:</p>
<pre><code class="language-typescript">coreApp.odm.setDb(db);
</code></pre>
<p>As we have said before, to create a model, we need to define its pure fields with the name of pure and the relations of that model in two types of inrelation and outrelation.</p>
<p>pure is merely a simple object with key of string and a value similar to <a href="https://github.com/ianstormtaylor/superstruct">SuperStruct</a> structure.</p>
<p>inrelation represents an <strong>array</strong> or a <strong>single</strong> pure object of another MongoDb collection, we want to embed in the current document. In SQL modeling, for every relation we save the key or id which we call inrelation. As an example, we have a blogPost which has a creator from the user collection and we save the pure model of the user in the blogPost collection.</p>
<p>outrelation specifies a relation for a specific collection but it could contain an unbound set of data that could outgrow the <strong>16MB</strong> limit size of a document in MongoDB. Thus we do not even save its key or id in SQL modeling. For example, we have a user entity who writes many blog posts and we save for example an array of pure objects of blogPost in order of the date published for the first pagination in the user collection containing the latest 50 blog posts.</p>
<p>Now let's get our hands dirty and create the user and country schemas:</p>
<p>First import string number optional InRelation and OutRelation from lesan :</p>
<pre><code class="language-typescript">import {
  InRelation,
  lesan,
  MongoClient,
  number,
  optional,
  OutRelation,
  string,
} from &quot;https://deno.land/x/lesan@vx.xx/mod.ts&quot;;
</code></pre>
<p>and then create the schema shapes:</p>
<pre><code class="language-typescript">const userPure = {
  name: string(),
  address: optional(string()),
  age: number(),
};

const countryPure = {
  name: string(),
  description: string(),
};

const userInRel: Record&lt;string, InRelation&gt; = {
  country: {
    schemaName: &quot;country&quot;,
    type: &quot;one&quot;,
    optional: false,
  },
};

const userOutRel = {};

const countryInRel: Record&lt;string, InRelation&gt; = {};

const countryOutRel: Record&lt;string, OutRelation&gt; = {
  users: {
    schemaName: &quot;user&quot;,
    number: 50,
    sort: { field: &quot;_id&quot;, order: &quot;desc&quot;, type: &quot;objectId&quot; },
  },
};
</code></pre>
<p>We should set the schema in coreApp:</p>
<pre><code class="language-typescript">const users = coreApp.odm.setModel(&quot;user&quot;, userPure, userInRel, userOutRel);
const countries = coreApp.odm.setModel(
  &quot;country&quot;,
  countryPure,
  countryInRel,
  countryOutRel
);
</code></pre>
<p>At this point, we need to have some endpoints to call from an HTTP request, so let's write some endpoints.</p>
<p>For creating an endpoint, we need to set the act from coreApp.acts.setAct function which requires type schema actName validator and fn.</p>
<ul>
<li>The type is just an enum of two possible options namely, static and dynamic.</li>
<li>schema is the name of the model to which we want to set an action.</li>
<li>actName is just a simple string to identify the act.</li>
<li>a validator is a superstruct object which is called before the act fn calling and validation the given data.</li>
<li>validator includes set and get objects.</li>
<li>fn is the function we call when a request for it arrives.</li>
</ul>
<p>The following is an one example of act:</p>
<p>Before creating act, import object and ActFn from lesan:</p>
<pre><code class="language-typescript">import {
  ActFn,
  InRelation,
  lesan,
  MongoClient,
  number,
  object,
  optional,
  OutRelation,
  string,
} from &quot;https://deno.land/x/lesan@vx.xx/mod.ts&quot;;
</code></pre>
<p>and the act will be in the following form:</p>
<pre><code class="language-typescript">const addUserValidator = () =&gt; {
  return object({
    set: object(userPure),
    get: coreApp.schemas.selectStruct(&quot;user&quot;, { country: 1 }),
  });
};

const addUser: ActFn = async (body) =&gt;
  await users.insertOne({
    doc: body.details.set,
    get: body.details.get,
  });

coreApp.acts.setAct({
  type: &quot;dynamic&quot;,
  schema: &quot;user&quot;,
  actName: &quot;addUser&quot;,
  validator: addUserValidator(),
  fn: addUser,
});
</code></pre>
<p>The last thing we need is just to run the web server:</p>
<pre><code class="language-typescript">coreApp.runServer({ port: 8080, typeGeneration: true, playground: false });
</code></pre>
<p>When typeGeneration is set to true, it creates a <strong>declarations</strong> folder with some typescript typings we need in the project.</p>
<p>Now run this command in the terminal:</p>
<pre><code class="language-typescript">deno run -A mod.ts
</code></pre>
<p>If the web server comes up correctly, you will see the following message:</p>
<p>We are all set and now we can send a POST HTTP request to http://localhost:8080/lesan, include the following in JSON format inside the body in order to retrieve the desired data:</p>
<pre><code class="language-typescript">{
  &quot;contents&quot;: &quot;dynamic&quot;,
  &quot;wants&quot;: {
    &quot;model&quot;: &quot;user&quot;,
    &quot;act&quot;: &quot;addUser&quot;
  },
  &quot;details&quot;: {
    &quot;set&quot;: {
      &quot;name&quot;: &quot;Seyyedeh Sare Hosseini&quot;,
      &quot;address&quot;: &quot;Iran, Hamedan&quot;,
      &quot;age&quot;: 5
    },
    &quot;get&quot;: {
      &quot;age&quot;: 1,
      &quot;address&quot;: 1
    }
  }
}
</code></pre>
<p>The working of projection for retrieving data is fundamentally based on <a href="https://www.mongodb.com/docs/manual/tutorial/project-fields-from-query-results/">MongoDb Projection</a>.</p>
<p>The coreApp.schemas.selectStruct function can limit the projection based on your schema relationships and prevent an infinite loop in retrieving data.</p>
<p>After running the server with typeGeneration set to true, the declarations folder is created and you can import userInp from generated type and make coreApp.schemas.selectStruct<userInp>(&quot;user&quot;, { country: 1 }) type safe:</p>
<pre><code class="language-typescript">import { userInp } from &quot;./declarations/selectInp.ts&quot;;

const addUserValidator = () =&gt; {
  return object({
    set: object(userPure),
    get: coreApp.schemas.selectStruct&lt;userInp&gt;(&quot;user&quot;, { country: 1 }),
  });
};
</code></pre>
<p>The following is the full example of what we have discussed so far:</p>
<pre><code class="language-typescript">import {
  ActFn,
  InRelation,
  lesan,
  MongoClient,
  number,
  object,
  optional,
  OutRelation,
  string,
} from &quot;https://deno.land/x/lesan@vx.xx/mod.ts&quot;;

const coreApp = lesan();

const client = new MongoClient();

await client.connect(&quot;mongodb://localhost:27017/arc&quot;);
const db = client.database(&quot;core&quot;);

coreApp.odm.setDb(db);

const userPure = {
  name: string(),
  address: optional(string()),
  age: number(),
};

const countryPure = {
  name: string(),
  description: string(),
};

const userInRel: Record&lt;string, InRelation&gt; = {
  country: {
    schemaName: &quot;country&quot;,
    type: &quot;one&quot;,
    optional: false,
  },
};

const userOutRel = {};

const countryInRel: Record&lt;string, InRelation&gt; = {};

const countryOutRel: Record&lt;string, OutRelation&gt; = {
  users: {
    schemaName: &quot;user&quot;,
    number: 50,
    sort: { field: &quot;_id&quot;, order: &quot;desc&quot;, type: &quot;objectId&quot; },
  },
};

const users = coreApp.odm.setModel(&quot;user&quot;, userPure, userInRel, userOutRel);
const countries = coreApp.odm.setModel(
  &quot;country&quot;,
  countryPure,
  countryInRel,
  countryOutRel
);

const addUserValidator = () =&gt; {
  return object({
    set: object(userPure),
    get: coreApp.schemas.selectStruct(&quot;user&quot;, { country: 1 }),
  });
};

const addUser: ActFn = async (body) =&gt;
  await users.insertOne({
    doc: body.details.set,
    get: body.details.get,
  });

coreApp.acts.setAct({
  type: &quot;dynamic&quot;,
  schema: &quot;user&quot;,
  actName: &quot;addUser&quot;,
  validator: addUserValidator(),
  fn: addUser,
});

const addCountryValidator = () =&gt; {
  return object({
    set: object(countryPure),
    get: coreApp.schemas.selectStruct(&quot;country&quot;, { users: 1 }),
  });
};

const addCountry: ActFn = async (body) =&gt; {
  const createdCountry = await countries.insertOne(body.details.set);
  return await countries.findOne({ _id: createdCountry }, body.details.get);
};

coreApp.acts.setAct({
  type: &quot;dynamic&quot;,
  schema: &quot;country&quot;,
  actName: &quot;addCountry&quot;,
  validator: addCountryValidator(),
  fn: addCountry,
});

coreApp.runServer({ port: 8080, typeGeneration: true, playground: false });
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Lesan_solution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="Microservice_Architecture_with_Lesan.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Lesan_solution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="Microservice_Architecture_with_Lesan.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
